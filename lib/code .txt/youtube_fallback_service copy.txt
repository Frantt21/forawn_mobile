// lib/services/youtube_fallback_service.dart
import 'dart:io';
import 'package:youtube_explode_dart/youtube_explode_dart.dart';
import 'package:path_provider/path_provider.dart';
import '../models/download_info.dart';

class YoutubeFallbackService {
  final YoutubeExplode _yt = YoutubeExplode();

  /// Busca en YouTube usando el título y artista de la canción
  Future<Video?> searchYoutubeVideo(String trackTitle, String artistName) async {
    try {
      // Construye una query de búsqueda optimizada para música
      final query = '$trackTitle $artistName official audio';
      print('[YoutubeFallback] Buscando en YouTube: $query');

      // Busca videos
      final searchResults = await _yt.search.search(query);
      
      if (searchResults.isEmpty) {
        print('[YoutubeFallback] No se encontraron resultados');
        return null;
      }

      // Retorna el primer resultado (usualmente el más relevante)
      final video = searchResults.first;
      print('[YoutubeFallback] Video encontrado: ${video.title} - ${video.id}');
      return video;
    } catch (e, st) {
      print('[YoutubeFallback] Error al buscar en YouTube: $e');
      print(st);
      return null;
    }
  }

  /// Obtiene la información de descarga desde un video de YouTube
  Future<DownloadInfo?> getDownloadInfoFromYoutube(String trackTitle, String artistName) async {
    try {
      final video = await searchYoutubeVideo(trackTitle, artistName);
      if (video == null) return null;

      // Obtiene el stream de audio de mejor calidad
      final manifest = await _yt.videos.streamsClient.getManifest(video.id);
      final audioStream = manifest.audioOnly.withHighestBitrate();

      if (audioStream == null) {
        print('[YoutubeFallback] No se encontró stream de audio');
        return null;
      }

      // Construye DownloadInfo compatible con tu sistema existente
      return DownloadInfo(
        name: video.title,
        artists: video.author,
        imageUrl: video.thumbnails.highResUrl,
        downloadUrl: audioStream.url.toString(),
        durationMs: video.duration?.inMilliseconds ?? 0,
      );
    } catch (e, st) {
      print('[YoutubeFallback] Error al obtener info de descarga: $e');
      print(st);
      return null;
    }
  }

  /// Descarga el audio directamente desde YouTube
  /// Retorna la ruta del archivo temporal descargado
  Future<String?> downloadAudioFromYoutube({
    required String trackTitle,
    required String artistName,
    required Function(double) onProgress,
  }) async {
    try {
      final video = await searchYoutubeVideo(trackTitle, artistName);
      if (video == null) return null;

      print('[YoutubeFallback] Descargando: ${video.title}');

      // Obtiene el stream de audio
      final manifest = await _yt.videos.streamsClient.getManifest(video.id);
      final audioStream = manifest.audioOnly.withHighestBitrate();

      if (audioStream == null) {
        print('[YoutubeFallback] No hay stream de audio disponible');
        return null;
      }

      // Crea archivo temporal
      final tempDir = await getTemporaryDirectory();
      final fileName = _sanitizeFileName('${video.title}.mp3');
      final tempPath = '${tempDir.path}/$fileName';
      final file = File(tempPath);

      // Stream de descarga con progreso
      final stream = _yt.videos.streamsClient.get(audioStream);
      final fileStream = file.openWrite();
      
      var downloaded = 0;
      final total = audioStream.size.totalBytes;

      await for (final data in stream) {
        fileStream.add(data);
        downloaded += data.length;
        
        if (total > 0) {
          final progress = downloaded / total;
          onProgress(progress);
        }
      }

      await fileStream.flush();
      await fileStream.close();

      print('[YoutubeFallback] Descarga completada: $tempPath');
      return tempPath;
    } catch (e, st) {
      print('[YoutubeFallback] Error al descargar: $e');
      print(st);
      return null;
    }
  }

  /// Limpia recursos
  void dispose() {
    _yt.close();
  }

  String _sanitizeFileName(String name) {
    return name.replaceAll(RegExp(r'[<>:"/\\|?*]'), '_');
  }
}